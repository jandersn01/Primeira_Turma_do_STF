<!DOCTYPE html>
<html lang="pt-br"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Meus Processos</title>
</head>
<body>

    <div layout:fragment="conteudo">
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="bi bi-folder2-open"></i> Meus Processos</h4>
            </div>
            
            <div class="card-body">
                
                <div th:if="${mensagem}" class="alert alert-success alert-dismissible fade show" role="alert" th:classappend="${mensagem.contains('Erro')} ? 'alert-danger' : 'alert-success'">
                    <span th:text="${mensagem}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- === BLOCO DE SIMULAÇÃO DE LOGIN (ALUNO) === -->
                <div th:if="${aluno != null}" class="card mb-4 border-info bg-light">
                    <div class="card-body py-2 d-flex align-items-center justify-content-between">
                        <div>
                            <i class="bi bi-person-badge text-info"></i> 
                            <strong>Aluno Logado:</strong> 
                            <span th:text="${aluno.nome}" class="fw-bold">Nome</span>
                            <span class="text-muted small" th:text="'(Mat: ' + ${aluno.matricula} + ')'"></span>
                        </div>
                        
                        <!-- Formulário de Troca -->
                        <form th:action="@{/aluno/processo/list}" method="get" class="d-flex align-items-center gap-2 ms-3 flex-grow-1">
                            <label for="trocaAluno" class="col-form-label col-form-label-sm fw-bold text-info text-nowrap">Simular Acesso:</label>
                            <select name="alunoId" id="trocaAluno" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option th:each="a : ${todosAlunos}" 
                                        th:value="${a.id}" 
                                        th:text="${a.nome + ' (Mat: ' + a.matricula + ')'}"
                                        th:selected="${a.id == aluno.id}">
                                </option>
                            </select>
                            
                            <!-- Manter filtros ao trocar -->
                            <input type="hidden" name="status" th:value="${statusSelecionado}" th:if="${statusSelecionado}" />
                            <input type="hidden" name="ordenacao" th:value="${ordenacaoSelecionada}" />
                        </form>
                    </div>
                </div>
                <!-- =========================================== -->

                <!-- Filtros de Processos -->
                <div th:if="${aluno != null}" class="mb-3">
                    <form method="get" th:action="@{/aluno/processo/list}" class="row g-2 align-items-end">
                        <input type="hidden" name="alunoId" th:value="${aluno.id}" />
                        
                        <div class="col-md-3">
                            <label class="form-label small">Status</label>
                            <select name="status" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option th:each="s : ${statusList}" th:value="${s}" th:text="${s.descricao}" th:selected="${s.name() == statusSelecionado}"></option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Assunto</label>
                            <select name="assuntoId" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option th:each="as : ${assuntos}" th:value="${as.id}" th:text="${as.nome}" th:selected="${as.id == assuntoSelecionado}"></option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-sm btn-secondary w-100">Filtrar</button>
                        </div>
                        <div class="col-md-4 text-end">
                             <a th:href="@{/aluno/processo/form}" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-lg"></i> Novo Processo
                             </a>
                        </div>
                    </form>
                </div>

                <!-- Tabela de Processos -->
                <div th:if="${aluno != null}">
                    <div th:if="${#lists.isEmpty(processos)}" class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Nenhum processo encontrado.
                    </div>

                    <div th:unless="${#lists.isEmpty(processos)}" class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Número</th>
                                    <th>Assunto</th>
                                    <th>Status</th>
                                    <th>Data Recepção</th>
                                    <th>Documentos</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="p : ${processos}">
                                    <td>
                                        <strong th:text="${p.numero}" class="text-primary">123/2024</strong>
                                    </td>
                                    <td th:text="${p.assunto.nome}">Assunto</td>
                                    <td>
                                        <span class="badge bg-secondary" th:if="${p.status.name() == 'CRIADO'}" th:text="${p.status.descricao}"></span>
                                        <span class="badge bg-info text-dark" th:if="${p.status.name() == 'DISTRIBUIDO'}" th:text="${p.status.descricao}"></span>
                                        <span class="badge bg-warning text-dark" th:if="${p.status.name() == 'EM_PAUTA'}" th:text="${p.status.descricao}"></span>
                                        <span class="badge bg-primary" th:if="${p.status.name() == 'EM_JULGAMENTO'}" th:text="${p.status.descricao}"></span>
                                        <span class="badge bg-success" th:if="${p.status.name() == 'JULGADO'}" th:text="${p.status.descricao}"></span>
                                    </td>
                                    <td th:text="${#temporals.format(p.dataRecepcao, 'dd/MM/yyyy')}"></td>
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-paperclip"></i> <span th:text="${#lists.size(p.documentos)}">0</span>
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="modal" th:data-bs-target="'#modalDocs' + ${p.id}">
                                            <i class="bi bi-folder2-open"></i> Gerenciar Docs
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modais de Documentos (Fora da tabela para evitar problemas de layout) -->
        <div th:if="${aluno != null}" th:each="p : ${processos}">
            <div class="modal fade" th:id="'modalDocs' + ${p.id}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title">Documentos do Processo <span th:text="${p.numero}"></span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                            <!-- Lista de Documentos Existentes -->
                            <h6 class="mb-3">Anexos:</h6>
                            <div th:if="${#lists.isEmpty(p.documentos)}" class="text-muted fst-italic mb-3">
                                Nenhum documento anexado.
                            </div>
                            
                            <ul th:unless="${#lists.isEmpty(p.documentos)}" class="list-group mb-4">
                                <li th:each="doc : ${p.documentos}" class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        <span th:text="${doc.nomeOriginal}">arquivo.pdf</span>
                                        <small class="text-muted ms-2" th:if="${doc.descricao}" th:text="'(' + ${doc.descricao} + ')'"></small>
                                    </div>
                                    <div class="btn-group">
                                        <a th:href="@{/aluno/processo/{pid}/documento/{did}/download(pid=${p.id}, did=${doc.id})}" class="btn btn-sm btn-outline-primary" title="Baixar">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <!-- Só permite excluir se o processo ainda estiver CRIADO -->
                                        <form th:if="${p.status.name() == 'CRIADO'}" 
                                              th:action="@{/aluno/processo/{pid}/documento/{did}/delete(pid=${p.id}, did=${doc.id})}" 
                                              method="post" 
                                              th:onsubmit="return confirm('Excluir este documento?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </li>
                            </ul>
                            
                            <hr>
                            
                            <!-- Formulário de Upload (Só se status for CRIADO) -->
                            <div th:if="${p.status.name() == 'CRIADO'}">
                                <h6 class="mb-3"><i class="bi bi-cloud-upload"></i> Adicionar Novo Documento</h6>
                                <form th:action="@{/aluno/processo/{id}/documento/upload(id=${p.id})}" method="post" enctype="multipart/form-data">
                                    <div class="input-group mb-2">
                                        <input type="file" name="arquivo" class="form-control" required>
                                    </div>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Descrição</span>
                                        <input type="text" name="descricao" class="form-control" placeholder="Opcional (ex: Histórico Escolar)">
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-success text-white">Enviar</button>
                                    </div>
                                </form>
                            </div>
                            <div th:unless="${p.status.name() == 'CRIADO'}" class="alert alert-warning py-2 small">
                                <i class="bi bi-lock"></i> O processo já foi tramitado e não aceita novos documentos.
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

</body>
</html>